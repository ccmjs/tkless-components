"use strict";(()=>{const DEFAULT_LINK_REL="noopener noreferrer nofollow";const LinkTarget={NONE:0,SELF:1,BLANK:2,PARENT:3,TOP:4};const NullCharactersRegExp=/\x00/g;const InvisibleCharactersRegExp=/[\x01-\x1F]/g;function removeNullCharacters(str,replaceInvisible=false){if(typeof str!=="string"){console.error(`The argument must be a string.`);return str}if(replaceInvisible){str=str.replace(InvisibleCharactersRegExp," ")}return str.replace(NullCharactersRegExp,"")}function parseQueryString(query){const params=new Map;for(const[key,value]of new URLSearchParams(query)){params.set(key.toLowerCase(),value)}return params}const addLinkAttributes=(link,{url:url,target:target="",rel:rel,enabled:enabled=true}={})=>{if(!url||typeof url!=="string"){throw new Error('A valid "url" parameter must provided.')}const urlNullRemoved=removeNullCharacters(url);if(enabled){link.href=link.title=urlNullRemoved}else{link.href="";link.title=`Disabled: ${urlNullRemoved}`;link.onclick=()=>false}let targetStr="";switch(target){case LinkTarget.NONE:break;case LinkTarget.SELF:targetStr="_self";break;case LinkTarget.BLANK:targetStr="_blank";break;case LinkTarget.PARENT:targetStr="_parent";break;case LinkTarget.TOP:targetStr="_top";break}link.target=targetStr;link.rel=typeof rel==="string"?rel:DEFAULT_LINK_REL};ccm.files["PDFLinkService.js"]=class PDFLinkService{#pagesRefCache=new Map;constructor({eventBus:eventBus,externalLinkTarget:externalLinkTarget=null,externalLinkRel:externalLinkRel=null,ignoreDestinationZoom:ignoreDestinationZoom=false}={}){this.eventBus=eventBus;this.externalLinkTarget=externalLinkTarget;this.externalLinkRel=externalLinkRel;this.externalLinkEnabled=true;this._ignoreDestinationZoom=ignoreDestinationZoom;this.baseUrl=null;this.pdfDocument=null;this.pdfViewer=null;this.pdfHistory=null}setCcmInstance(instance){this.ccmInstance=instance}setDocument(pdfDocument,baseUrl=null){this.baseUrl=baseUrl;this.pdfDocument=pdfDocument;this.#pagesRefCache.clear()}get pagesCount(){return this.pdfDocument?this.pdfDocument.numPages:0}get page(){return this.ccmInstance?.getPage()}set page(value){this.ccmInstance?.events.onJump({target:{value:value}})}get rotation(){console.info("pdf rotation not implemented!")}set rotation(value){console.info("pdf rotation not implemented!")}#goToDestinationHelper(rawDest,namedDest=null,explicitDest){const destRef=explicitDest[0];let pageNumber;if(typeof destRef==="object"&&destRef!==null){pageNumber=this._cachedPageNumber(destRef);if(!pageNumber){this.pdfDocument.getPageIndex(destRef).then((pageIndex=>{this.cachePageRef(pageIndex+1,destRef);this.#goToDestinationHelper(rawDest,namedDest,explicitDest)})).catch((()=>{console.error(`PDFLinkService.#goToDestinationHelper: "${destRef}" is not `+`a valid page reference, for dest="${rawDest}".`)}));return}}else if(Number.isInteger(destRef)){pageNumber=destRef+1}else{console.error(`PDFLinkService.#goToDestinationHelper: "${destRef}" is not `+`a valid destination reference, for dest="${rawDest}".`);return}if(!pageNumber||pageNumber<1||pageNumber>this.pagesCount){console.error(`PDFLinkService.#goToDestinationHelper: "${pageNumber}" is not `+`a valid page number, for dest="${rawDest}".`);return}this.ccmInstance?.events.onJump({target:{value:pageNumber}})}async goToDestination(dest){if(!this.pdfDocument){return}let namedDest,explicitDest;if(typeof dest==="string"){namedDest=dest;explicitDest=await this.pdfDocument.getDestination(dest)}else{namedDest=null;explicitDest=await dest}if(!Array.isArray(explicitDest)){console.error(`PDFLinkService.goToDestination: "${explicitDest}" is not `+`a valid destination array, for dest="${dest}".`);return}this.#goToDestinationHelper(dest,namedDest,explicitDest)}goToPage(val){if(!this.pdfDocument){return}const pageNumber=val|0;if(!(Number.isInteger(pageNumber)&&pageNumber>0&&pageNumber<=this.pagesCount)){console.error(`PDFLinkService.goToPage: "${val}" is not a valid page.`);return}this.ccmInstance?.events.onJump({target:{value:pageNumber}})}addLinkAttributes(link,url,newWindow=false){addLinkAttributes(link,{url:url,target:this.ccmInstance?.force_target_blank||newWindow?LinkTarget.BLANK:this.externalLinkTarget,rel:this.externalLinkRel,enabled:this.externalLinkEnabled})}getDestinationHash(dest){if(typeof dest==="string"){if(dest.length>0){return this.getAnchorUrl("#"+escape(dest))}}else if(Array.isArray(dest)){const str=JSON.stringify(dest);if(str.length>0){return this.getAnchorUrl("#"+escape(str))}}return this.getAnchorUrl("")}getAnchorUrl(anchor){return(this.baseUrl||"")+anchor}setHash(hash){if(!this.pdfDocument){return}let pageNumber,dest;if(hash.includes("=")){const params=parseQueryString(hash);if(params.has("search")){this.eventBus.dispatch("findfromurlhash",{source:this,query:params.get("search").replace(/"/g,""),phraseSearch:params.get("phrase")==="true"})}if(params.has("page")){pageNumber=params.get("page")|0||1}if(params.has("zoom")){const zoomArgs=params.get("zoom").split(",");const zoomArg=zoomArgs[0];const zoomArgNumber=parseFloat(zoomArg);if(!zoomArg.includes("Fit")){dest=[null,{name:"XYZ"},zoomArgs.length>1?zoomArgs[1]|0:null,zoomArgs.length>2?zoomArgs[2]|0:null,zoomArgNumber?zoomArgNumber/100:zoomArg]}else{if(zoomArg==="Fit"||zoomArg==="FitB"){dest=[null,{name:zoomArg}]}else if(zoomArg==="FitH"||zoomArg==="FitBH"||zoomArg==="FitV"||zoomArg==="FitBV"){dest=[null,{name:zoomArg},zoomArgs.length>1?zoomArgs[1]|0:null]}else if(zoomArg==="FitR"){if(zoomArgs.length!==5){console.error('PDFLinkService.setHash: Not enough parameters for "FitR".')}else{dest=[null,{name:zoomArg},zoomArgs[1]|0,zoomArgs[2]|0,zoomArgs[3]|0,zoomArgs[4]|0]}}else{console.error(`PDFLinkService.setHash: "${zoomArg}" is not a valid zoom value.`)}}}if(dest){this.ccmInstance.events.onJump({target:{value:pageNumber||this.page}})}else if(pageNumber){this.page=pageNumber}if(params.has("pagemode")){this.eventBus.dispatch("pagemode",{source:this,mode:params.get("pagemode")})}if(params.has("nameddest")){this.goToDestination(params.get("nameddest"))}}else{dest=unescape(hash);try{dest=JSON.parse(dest);if(!Array.isArray(dest)){dest=dest.toString()}}catch(ex){}if(typeof dest==="string"||PDFLinkService.#isValidExplicitDestination(dest)){this.goToDestination(dest);return}console.error(`PDFLinkService.setHash: "${unescape(hash)}" is not a valid destination.`)}}executeNamedAction(action){switch(action){case"GoBack":this.pdfHistory?.back();break;case"GoForward":this.pdfHistory?.forward();break;case"NextPage":this.ccmInstance?.events.onJump({target:{value:this.ccmInstance.getPage()+1}});break;case"PrevPage":this.ccmInstance?.events.onJump({target:{value:this.ccmInstance.getPage()-1}});break;case"LastPage":this.page=this.pagesCount;break;case"FirstPage":this.page=1;break;default:break}this.eventBus.dispatch("namedaction",{source:this,action:action})}cachePageRef(pageNum,pageRef){if(!pageRef){return}const refStr=pageRef.gen===0?`${pageRef.num}R`:`${pageRef.num}R${pageRef.gen}`;this.#pagesRefCache.set(refStr,pageNum)}_cachedPageNumber(pageRef){if(!pageRef){return null}const refStr=pageRef.gen===0?`${pageRef.num}R`:`${pageRef.num}R${pageRef.gen}`;return this.#pagesRefCache.get(refStr)||null}isPageVisible(pageNumber){return this.pdfViewer.isPageVisible(pageNumber)}isPageCached(pageNumber){return this.pdfViewer.isPageCached(pageNumber)}static#isValidExplicitDestination(dest){if(!Array.isArray(dest)){return false}const destLength=dest.length;if(destLength<2){return false}const page=dest[0];if(!(typeof page==="object"&&Number.isInteger(page.num)&&Number.isInteger(page.gen))&&!(Number.isInteger(page)&&page>=0)){return false}const zoom=dest[1];if(!(typeof zoom==="object"&&typeof zoom.name==="string")){return false}let allowNull=true;switch(zoom.name){case"XYZ":if(destLength!==5){return false}break;case"Fit":case"FitB":return destLength===2;case"FitH":case"FitBH":case"FitV":case"FitBV":if(destLength!==3){return false}break;case"FitR":if(destLength!==6){return false}allowNull=false;break;default:return false}for(let i=2;i<destLength;i++){const param=dest[i];if(!(typeof param==="number"||allowNull&&param===null)){return false}}return true}}})();
//# sourceMappingURL=PDFLinkService.min.js.map